---
title: "Case_Study_2"
author: "Ben Tanaka"
date: "7/29/2019"
output: 
  html_document:
    keep_md: true
---

```{r setup, echo=FALSE, include=FALSE, warning=FALSE,message =FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE,message =FALSE)
library(xml2)
library(rvest)
library(stringr)
library(tibble)
library(data.table)
library(knitr)
library(kableExtra)
library(dplyr)
library(tidyr)
library(ggplot2)
library(bizdays)
library(MTS)
library(forecast)
library(smooth)
library(fpp2)
library(lubridate)
library(dygraphs)
library(xts)
library(readxl)
library(tidyverse)
library(gridExtra)
library(grid)
library(ggplot2)
library(lattice)
library(GGally)
library(psych)
library(scales)
library(cowplot)

setwd("/users/ben/documents/r/Case_Study_2")
getwd()
```

# DDSAnalytics:  Predicting Employee Turnover

```{r ETL}
df_emp_ren <- read_excel("CaseStudy2-data.xlsx")
names(df_emp_ren)

df_emp_ren$Attrition_Lvl <- factor(df_emp_ren$Attrition)
str(df_emp_ren)
summary(df_emp_ren)

```
## Transform Factors into actual results

``` {r Transform Factors}
df_emp_ren <- df_emp_ren %>%
  mutate(Education = as.factor(if_else(Education == 1,"Below College", if_else(Education == 2, "College", if_else(Education == 3, "Bachelor", if_else(Education == 4, "Master","Doctor")))))
         ,EnvironmentSatisfaction = as.factor(if_else(EnvironmentSatisfaction == 1,"Low",if_else(EnvironmentSatisfaction == 2, "Medium", if_else(EnvironmentSatisfaction == 3, "High", "Very High"))))
         ,JobInvolvement = as.factor(if_else(JobInvolvement == 1,"Low",if_else(JobInvolvement == 2, "Medium",if_else(JobInvolvement == 3, "High", "Very High"))))
         ,JobSatisfaction = as.factor(if_else(JobSatisfaction == 1, "Low",if_else(JobSatisfaction == 2, "Medium",if_else(JobSatisfaction == 3, "High","Very High"))))
         ,PerformanceRating = as.factor(if_else(PerformanceRating == 1, "Low",if_else(PerformanceRating == 2, "Good", if_else(PerformanceRating == 3, "Excellent", "Outstanding"))))
         ,RelationshipSatisfaction = as.factor(if_else(RelationshipSatisfaction == 1, "Low",if_else(RelationshipSatisfaction == 2, "Medium", if_else(RelationshipSatisfaction == 3, "High", "Very High"))))
         ,WorkLifeBalance = as.factor(if_else(WorkLifeBalance == 1, "Bad",if_else(WorkLifeBalance == 2, "Good", if_else(WorkLifeBalance == 3, "Better", "Best"))))
         ,JobLevel = as.factor(JobLevel)
         )
```

## Employee Personal Demographics
``` {r Employee_Demographics}

p1 <- ggplot(df_emp_ren, aes(x=EducationField ,  group=Attrition)) +
geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") +
geom_text(aes( label = scales::percent(..prop..),
y= ..prop.. ), stat= "count", size = 2.5, position=position_dodge(width=0.2)) +
labs(y = "Percent", fill="EducationField") +
theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) +
theme(legend.position = "none") +
ggtitle("Attrition Counts - Education Field")+
facet_grid(~Attrition) +
scale_y_continuous(labels = scales::percent)

p2 <- df_emp_ren %>%
  group_by(EducationField) %>%
  summarise(attrition_rate = round((sum(if_else(Attrition == "Yes",1,0))/n()*100),2)) %>%
  ggplot(aes(x = EducationField, y = attrition_rate))+ geom_bar(stat = 'identity',fill = "coral3") + ggtitle("Attrition Rate - Education Field") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) +geom_text(aes(label=attrition_rate), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25)+ scale_y_continuous(limits = c(0, 30))

p3 <- ggplot(df_emp_ren, aes(x=Education ,  group=Attrition)) +
geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") +
geom_text(aes( label = scales::percent(..prop..),
y= ..prop.. ), stat= "count",  size = 2.5, position=position_dodge(width=0.2)) +
labs(y = "Percent", fill="Attrition_Lvl") +
  theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) +
  theme(legend.position = "none") +
  ggtitle("Attrition Counts - Education")+
facet_grid(~Attrition) +
scale_y_continuous(labels = scales::percent)

p4 <- df_emp_ren %>%
  group_by(Education) %>%
  summarise(attrition_rate = round((sum(if_else(Attrition == "Yes",1,0))/n()*100),2)) %>%
  ggplot(aes(x = Education, y = attrition_rate))+ geom_bar(stat = 'identity',fill = "coral3") + ggtitle("Attrition Rate - Education") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) +geom_text(aes(label=attrition_rate), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25)+ scale_y_continuous(limits = c(0, 30))


grid.arrange(p1, p2, p3, p4, nrow = 2, ncol = 2)


EmpPerDem2 <- df_emp_ren[c("NumCompaniesWorked","TotalWorkingYears", "DistanceFromHome" ,"Attrition_Lvl")]
ggpairs(EmpPerDem2)

p1 <- df_emp_ren %>%
  ggplot(aes(x = NumCompaniesWorked, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Number Companies Worked")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p2 <- df_emp_ren %>%
  ggplot(aes(x = TotalWorkingYears, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Total Working Years")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p3 <- df_emp_ren %>%
  ggplot(aes(x = DistanceFromHome, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Distance From Home")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

grid.arrange(p1, p2, p3, nrow = 2, ncol = 2)


p1 <- ggplot(df_emp_ren, aes(x=MaritalStatus ,  group=Attrition)) +
geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") +
geom_text(aes( label = scales::percent(..prop..),
y= ..prop.. ), stat= "count", size = 2.5, position=position_dodge(width=0.2)) +
labs(y = "Percent", fill="MaritalStatus") +
theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) +
theme(legend.position = "none") +
ggtitle("Attrition Counts - Marital Status")+
facet_grid(~Attrition) +
scale_y_continuous(labels = scales::percent)

p2 <- df_emp_ren %>%
  group_by(MaritalStatus) %>%
  summarise(attrition_rate = round((sum(if_else(Attrition == "Yes",1,0))/n()*100),2)) %>%
  ggplot(aes(x = MaritalStatus, y = attrition_rate))+ geom_bar(stat = 'identity',fill = "coral3") + ggtitle("Attrition Rate - MaritalStatus") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) +geom_text(aes(label=attrition_rate), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25)+ scale_y_continuous(limits = c(0, 30))


p3 <- ggplot(df_emp_ren, aes(x=Gender ,  group=Attrition)) +
geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") +
geom_text(aes( label = scales::percent(..prop..),
y= ..prop.. ), stat= "count", size = 2.5, position=position_dodge(width=0.2)) +
labs(y = "Percent", fill="Gender") +
theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) +
theme(legend.position = "none") +
ggtitle("Attrition Counts - Gender")+
facet_grid(~Attrition) +
scale_y_continuous(labels = scales::percent)

p4 <- df_emp_ren %>%
  group_by(Gender) %>%
  summarise(attrition_rate = round((sum(if_else(Attrition == "Yes",1,0))/n()*100),2)) %>%
  ggplot(aes(x = Gender, y = attrition_rate))+ geom_bar(stat = 'identity',fill = "coral3") + ggtitle("Attrition Rate - Gender") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) +geom_text(aes(label=attrition_rate), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25)+ scale_y_continuous(limits = c(0, 30))


grid.arrange(p1, p2, p3, p4, nrow = 2, ncol = 2)

EmpPerDem3 <- df_emp_ren[c("Age","Attrition_Lvl")]
ggpairs(EmpPerDem3)

p3 <- df_emp_ren %>%
  ggplot(aes(x = Age, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Age")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p3
```

### Employee Personal Demographics:  Insights
* Insights:
    1.  enter insights here
      + Hypothesis: 


## Employee Pay Rates
``` {r Employee Pay Rates}
EmpPayRte1 <- df_emp_ren[c("HourlyRate", "DailyRate", "MonthlyRate","MonthlyIncome", "PercentSalaryHike","Attrition_Lvl")]
ggpairs(EmpPayRte1)

p1 <- df_emp_ren %>%
  ggplot(aes(x = HourlyRate, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Hourly Rate")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p2 <- df_emp_ren %>%
  ggplot(aes(x = DailyRate, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Daily Rate")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p3 <- df_emp_ren %>%
  ggplot(aes(x = MonthlyRate, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Monthly Rate")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p4 <- df_emp_ren %>%
  ggplot(aes(x = MonthlyIncome, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Monthly Income")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p5 <- df_emp_ren %>%
  ggplot(aes(x = PercentSalaryHike, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Percent Salary Hike")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

grid.arrange(p1, p2, p3, p4, p5, nrow = 3, ncol = 3)

EmpPayRte2 <- df_emp_ren[c("StockOptionLevel","OverTime","Attrition_Lvl")]
ggpairs(EmpPayRte2)

p1 <- df_emp_ren %>%
  ggplot(aes(x = StockOptionLevel, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Stock Option Level")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p2 <- df_emp_ren %>%
  ggplot(aes(x = OverTime, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Over Time")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())


grid.arrange(p1, p2, nrow = 1, ncol = 2)
```

### Employee Pay Rates:  Insights
* Insights:
    1.  enter insights here
      + Hypothesis: 

## Employee Work Profile Demographics
```{r Employee Work Profile Demographics}
EmpPflDem1 <- df_emp_ren[c("YearsWithCurrManager","YearsSinceLastPromotion","YearsInCurrentRole","YearsAtCompany","PerformanceRating", "Attrition_Lvl")]
ggpairs(EmpPflDem1)

p1 <- df_emp_ren %>%
  ggplot(aes(x = YearsWithCurrManager, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Years With Current Manager")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p2 <- df_emp_ren %>%
  ggplot(aes(x = YearsSinceLastPromotion, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Years Since Last Promotion")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p3 <- df_emp_ren %>%
  ggplot(aes(x = YearsInCurrentRole, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Years In Current Role")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p4 <- df_emp_ren %>%
  ggplot(aes(x = YearsAtCompany, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Years At Company")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p5 <- df_emp_ren %>%
  ggplot(aes(x = PerformanceRating, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Performance Rating")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

grid.arrange(p1, p2, p3, p4, p5, nrow = 3, ncol = 3)

EmpPflDem2 <- df_emp_ren[c("WorkLifeBalance","RelationshipSatisfaction","JobSatisfaction","JobInvolvement","EnvironmentSatisfaction", "Attrition_Lvl")]
ggpairs(EmpPflDem2)

p1 <- df_emp_ren %>%
  ggplot(aes(x = WorkLifeBalance, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Work Life Balance")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p2 <- df_emp_ren %>%
  ggplot(aes(x = RelationshipSatisfaction, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Relationship Satisfaction")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p3 <- df_emp_ren %>%
  ggplot(aes(x = JobSatisfaction, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Job Satisfaction")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p4 <- df_emp_ren %>%
  ggplot(aes(x = JobInvolvement, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Job Involvement")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p5 <- df_emp_ren %>%
  ggplot(aes(x = EnvironmentSatisfaction, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Environment Satisfaction")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

grid.arrange(p1, p2, p3, p4, p5, nrow = 3, ncol = 3)

EmpPflDem3 <- df_emp_ren[c("TrainingTimesLastYear","StandardHours","JobRole","JobLevel","Department","BusinessTravel", "Attrition_Lvl")]
ggpairs(EmpPflDem3)

p1 <- df_emp_ren %>%
  ggplot(aes(x = TrainingTimesLastYear, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Training Times Last Year")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p2 <- df_emp_ren %>%
  ggplot(aes(x = StandardHours, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Standard Hours")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p3 <- df_emp_ren %>%
  ggplot(aes(x = JobRole, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Job Role")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p4 <- df_emp_ren %>%
  ggplot(aes(x = Department, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Department")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p5 <- df_emp_ren %>%
  ggplot(aes(x = BusinessTravel, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Business Travel")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

grid.arrange(p1, p2, p3, p4, p5, nrow = 3, ncol = 3)

EmpPflDem4 <- df_emp_ren[c("YearsAtCompany", "YearsInCurrentRole", "YearsSinceLastPromotion","YearsWithCurrManager", "Attrition_Lvl")]
ggpairs(EmpPflDem4)

p1 <- df_emp_ren %>%
  ggplot(aes(x = YearsAtCompany, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Years At Company")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p2 <- df_emp_ren %>%
  ggplot(aes(x = YearsInCurrentRole, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Years In Current Role")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p3 <- df_emp_ren %>%
  ggplot(aes(x = YearsSinceLastPromotion, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Years Since Last Promotion")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p4 <- df_emp_ren %>%
  ggplot(aes(x = YearsWithCurrManager, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Years With Current Manager")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

grid.arrange(p1, p2, p3, p4,  nrow = 2, ncol = 2)

```

### Employee Work Profile Demographics:  Insights
* Insights:
    1.  enter insights here
      + Hypothesis: 
      
      
  
``` {r Deep_Dives}
p1 <- ggplot(df_emp_ren, aes(x= Attrition,  group=EducationField)) +
geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") +
geom_text(aes( label = scales::percent(..prop..),
y= ..prop.. ), stat= "count", vjust = -.5) +
labs(y = "Percent", fill="Attrition_Lvl") +
facet_grid(~EducationField) +
scale_y_continuous(labels = scales::percent)




```

